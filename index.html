<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>iManager</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        :root {
            --primary: #1a1a1a;
            --secondary: #2d2d2d;
            --accent: #d4af37;
            --gold: #d4af37;
            --gold-light: #f4e4bc;
            --success: #4a4a4a;
            --danger: #8b0000;
            --warning: #d4af37;
            --light: #f5f5f5;
            --dark: #1a1a1a;
            --gray: #6c6c6c;
            --gray-light: #e5e5e5;
            --white: #ffffff;
            --black: #000000;
            --luxury-gradient: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
            --gold-gradient: linear-gradient(135deg, #d4af37 0%, #f4e4bc 100%);
            --premium-gradient: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 50%, #1a1a1a 100%);
            --shadow-luxury: 0 10px 40px rgba(0, 0, 0, 0.15);
            --shadow-luxury-hover: 0 20px 60px rgba(0, 0, 0, 0.25);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', 'Segoe UI', -apple-system, BlinkMacSystemFont, sans-serif;
        }

        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');

        body {
            background: var(--cream);
            background-attachment: fixed;
            color: var(--dark);
            line-height: 1.6;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background: var(--oxford-blue);
            color: var(--cream);
            padding: 35px 0;
            border-radius: 20px;
            margin-bottom: 40px;
            box-shadow: var(--shadow-luxury);
            border: 2px solid var(--gold);
            position: relative;
            overflow: hidden;
        }

        header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--gold);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 20px;
        }

        h1 {
            font-size: 2.5rem;
            margin-bottom: 8px;
            font-weight: 800;
            letter-spacing: -1px;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .subtitle {
            font-size: 1.1rem;
            opacity: 0.95;
            font-weight: 500;
            letter-spacing: 0.5px;
        }

        .dashboard {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: var(--cream);
            border-radius: 24px;
            padding: 30px;
            box-shadow: var(--shadow-luxury);
            border: 1px solid rgba(0, 33, 71, 0.1);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
        }

        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--gold);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-luxury-hover);
            border-color: var(--oxford-blue);
        }

        .card:hover::before {
            opacity: 1;
        }

        .card h2 {
            color: var(--oxford-blue);
            margin-bottom: 20px;
            font-size: 1.4rem;
            font-weight: 700;
            border-bottom: 3px solid var(--gold);
            padding-bottom: 15px;
            letter-spacing: 1px;
            text-transform: uppercase;
        }

        .salary-summary {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
        }

        .salary-item {
            text-align: center;
        }

        .salary-value {
            font-size: 2rem;
            font-weight: 800;
            color: var(--oxford-blue);
            letter-spacing: 1px;
        }

        .salary-label {
            font-size: 0.9rem;
            color: var(--gray);
        }

        .progress-bar {
            height: 12px;
            background: var(--gray-light);
            border-radius: 10px;
            margin: 20px 0;
            overflow: hidden;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .progress {
            height: 100%;
            background: var(--gold);
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(212, 175, 55, 0.3);
            transition: width 0.6s ease;
        }

        .shift-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        .shift-summary {
            background: var(--light);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }

        .shift-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--primary);
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.95rem;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: left 0.5s;
        }

        .btn:hover::before {
            left: 100%;
        }

        .btn-primary {
            background: var(--oxford-blue);
            color: var(--cream);
            border: 2px solid var(--oxford-blue);
            box-shadow: 0 4px 15px rgba(0, 33, 71, 0.2);
        }

        .btn-primary:hover {
            background: var(--gold);
            color: var(--oxford-blue);
            border-color: var(--gold);
        }

        .btn-danger {
            background: var(--danger);
            color: white;
            border: 2px solid var(--danger);
            box-shadow: 0 4px 15px rgba(139, 0, 0, 0.2);
        }

        .btn-danger:hover {
            background: #a00000;
            border-color: #a00000;
        }

        .btn-success {
            background: var(--oxford-blue);
            color: var(--cream);
            border: 2px solid var(--oxford-blue);
            box-shadow: 0 4px 15px rgba(0, 33, 71, 0.2);
        }

        .btn-success:hover {
            background: var(--secondary);
            border-color: var(--secondary);
        }

        .btn-warning {
            background: var(--gold);
            color: var(--oxford-blue);
            font-weight: 700;
            border: 2px solid var(--gold);
            box-shadow: 0 4px 15px rgba(212, 175, 55, 0.3);
        }

        .btn-warning:hover {
            background: #f4e4bc;
            border-color: #f4e4bc;
        }

        .btn:hover {
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 12px 35px rgba(0, 0, 0, 0.2);
        }

        .btn:active {
            transform: translateY(-1px) scale(0.98);
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }

        input,
        select,
        textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1rem;
        }

        textarea {
            min-height: 100px;
            resize: vertical;
        }

        .expense-list {
            margin-top: 20px;
        }

        .expense-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 18px 20px;
            margin-bottom: 12px;
            background: var(--cream);
            border-radius: 16px;
            box-shadow: 0 2px 10px rgba(0, 33, 71, 0.1);
            border-left: 4px solid var(--gold);
            transition: all 0.3s ease;
        }

        .expense-item:hover {
            transform: translateX(5px);
            box-shadow: 0 4px 20px rgba(0, 33, 71, 0.15);
            border-left-color: var(--oxford-blue);
        }

        .expense-icon {
            font-size: 1.2rem;
            margin-right: 10px;
            width: 30px;
            text-align: center;
        }

        .expense-amount {
            font-weight: bold;
            color: var(--danger);
        }

        .notes-list {
            margin-top: 20px;
        }

        .note-item {
            padding: 20px;
            margin-bottom: 20px;
            background: var(--cream);
            border-radius: 15px;
            box-shadow: 0 2px 10px rgba(0, 33, 71, 0.1);
            border-left: 5px solid var(--gold);
            transition: all 0.3s ease;
        }

        .note-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 20px rgba(0, 33, 71, 0.15);
            border-left-color: var(--oxford-blue);
        }

        .note-title {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .note-date {
            font-size: 0.8rem;
            color: var(--gray);
            text-align: right;
        }

        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid #ddd;
        }

        .tab {
            padding: 10px 20px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
        }

        .tab.active {
            border-bottom: 3px solid var(--primary);
            color: var(--primary);
            font-weight: bold;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .expense-categories {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .category-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }

        .category-icon {
            font-size: 1.5rem;
            margin-bottom: 10px;
            color: var(--primary);
        }

        .category-amount {
            font-weight: bold;
            font-size: 1.2rem;
        }

        .month-selector {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
            gap: 10px;
        }

        .month-selector select {
            width: auto;
        }

        .shift-controls {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .shift-controls button {
            flex: 1;
        }

        .salary-controls {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .salary-controls button {
            flex: 1;
        }

        .monthly-history {
            margin-top: 20px;
        }

        .history-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 15px;
            margin-bottom: 10px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }

        .download-btn {
            background-color: var(--success);
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 15px;
        }

        .download-btn:hover {
            opacity: 0.9;
        }

        /* MODERN TASKS SECTION STYLES */
        .tasks-header {
            background: var(--oxford-blue);
            color: var(--cream);
            padding: 35px 30px;
            border-radius: 0 0 30px 30px;
            margin: -30px -30px 30px -30px;
            box-shadow: var(--shadow-luxury);
            position: relative;
            overflow: hidden;
            border-bottom: 3px solid var(--gold);
        }

        .greeting {
            font-size: 1.8rem;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .time-left {
            font-size: 0.9rem;
            opacity: 0.9;
            margin-bottom: 15px;
        }

        .progress-container {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
        }

        .progress-percent {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .progress-text {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .progress-bar-task {
            height: 6px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 3px;
            margin: 10px 0;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: white;
            border-radius: 3px;
        }

        .search-container {
            background: var(--cream);
            border-radius: 16px;
            padding: 16px 20px;
            display: flex;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0, 33, 71, 0.1);
            margin-bottom: 25px;
            border: 1px solid rgba(0, 33, 71, 0.2);
            transition: all 0.3s ease;
        }

        .search-container:focus-within {
            box-shadow: 0 4px 20px rgba(0, 33, 71, 0.15);
            transform: translateY(-2px);
            border-color: var(--gold);
        }

        .search-container i {
            color: #8e8e93;
            margin-right: 10px;
        }

        .search-container input {
            border: none;
            background: transparent;
            width: 100%;
            font-size: 1rem;
            outline: none;
        }

        .categories {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            overflow-x: auto;
            padding-bottom: 5px;
        }

        .category-chip {
            background: var(--cream);
            padding: 10px 20px;
            border-radius: 25px;
            font-size: 0.9rem;
            font-weight: 600;
            box-shadow: 0 2px 10px rgba(0, 33, 71, 0.1);
            white-space: nowrap;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: 2px solid rgba(0, 33, 71, 0.2);
            color: var(--oxford-blue);
        }

        .category-chip:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 33, 71, 0.15);
            border-color: var(--gold);
        }

        .category-chip.active {
            background: var(--oxford-blue);
            color: var(--cream);
            border-color: var(--gold);
            box-shadow: 0 4px 20px rgba(0, 33, 71, 0.2);
        }

        .section-title {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 25px 0 15px 0;
        }

        .section-title h3 {
            font-size: 1.2rem;
            font-weight: 600;
            color: #1d1d1f;
        }

        .task-item {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(15px);
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 16px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.1);
            border-left: 5px solid;
            border-image: var(--premium-gradient) 1;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: 1px solid rgba(255, 255, 255, 0.4);
            position: relative;
            overflow: hidden;
        }

        .task-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(212, 175, 55, 0.05), transparent);
            transition: left 0.5s;
        }

        .task-item:hover::before {
            left: 100%;
        }

        .task-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            border-left-color: var(--dark);
        }

        .task-item.pinned {
            border-left-color: var(--gold);
        }

        .task-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 8px;
        }

        .task-title {
            font-weight: 600;
            font-size: 1rem;
            color: #1d1d1f;
            margin-bottom: 5px;
        }

        .task-description {
            font-size: 0.9rem;
            color: #8e8e93;
            margin-bottom: 10px;
        }

        .task-meta {
            display: flex;
            align-items: center;
            font-size: 0.8rem;
            color: #8e8e93;
            margin-bottom: 12px;
        }

        .task-date {
            margin-right: 15px;
            display: flex;
            align-items: center;
        }

        .task-date i {
            margin-right: 5px;
            font-size: 0.7rem;
        }

        .task-category {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 500;
            margin-right: 8px;
            background: #f2f2f7;
            color: #1d1d1f;
        }

        .task-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-top: 1px solid #f2f2f7;
            padding-top: 12px;
        }

        .task-status {
            display: flex;
            align-items: center;
            font-size: 0.8rem;
            color: #8e8e93;
        }

        .task-status i {
            margin-right: 5px;
        }

        .task-buttons {
            display: flex;
            gap: 10px;
        }

        .task-btn {
            background: none;
            border: none;
            color: #4361ee;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            cursor: pointer;
        }

        .task-btn i {
            margin-right: 5px;
        }

        .completed-task {
            opacity: 0.7;
            background: #f8f9fa;
        }

        .completed-task .task-title {
            text-decoration: line-through;
        }

        .pinned-badge {
            background: #f8961e;
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.7rem;
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }

        .pinned-badge i {
            margin-right: 5px;
            font-size: 0.6rem;
        }

        .completed-section {
            margin-top: 30px;
        }

        .empty-state {
            text-align: center;
            padding: 30px 20px;
            color: #8e8e93;
        }

        .empty-state i {
            font-size: 2.5rem;
            margin-bottom: 15px;
            opacity: 0.5;
        }

        .task-form {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        .task-form h3 {
            margin-bottom: 15px;
            color: var(--primary);
        }

        /* NEW STYLES FOR TASK ENHANCEMENTS */
        .fab {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 70px;
            height: 70px;
            background: var(--oxford-blue);
            color: var(--gold);
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 28px;
            box-shadow: var(--shadow-luxury);
            cursor: pointer;
            z-index: 1000;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            border: 3px solid var(--gold);
        }

        .fab:hover {
            transform: scale(1.15) rotate(90deg);
            background: var(--gold);
            color: var(--oxford-blue);
            box-shadow: var(--shadow-luxury-hover);
        }

        .fab:active {
            transform: scale(1.05) rotate(90deg);
        }

        .task-details-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }

        .task-details-content {
            background: white;
            width: 90%;
            max-width: 500px;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            position: relative;
        }

        .task-details-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }

        .task-details-title {
            font-size: 1.4rem;
            font-weight: 600;
            color: var(--dark);
        }

        .task-details-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--gray);
        }

        .task-details-body {
            margin-bottom: 25px;
        }

        .task-details-description {
            margin-bottom: 20px;
            color: var(--dark);
            line-height: 1.6;
        }

        .task-details-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 20px;
        }

        .task-details-meta-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
            color: var(--gray);
        }

        .task-details-actions {
            display: flex;
            justify-content: space-between;
            gap: 10px;
        }

        .task-details-action-btn {
            flex: 1;
            padding: 10px 15px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.2s ease;
        }

        .task-details-action-btn:hover {
            transform: translateY(-2px);
        }

        .task-details-complete {
            background: var(--success);
            color: white;
        }

        .task-details-edit {
            background: var(--primary);
            color: white;
        }

        .task-details-pin {
            background: var(--warning);
            color: white;
        }

        .task-details-delete {
            background: var(--danger);
            color: white;
        }

        .task-completed {
            opacity: 0.7;
            background: #f8f9fa;
        }

        .task-completed .task-title {
            text-decoration: line-through;
        }

        .task-pinned {
            border-left-color: var(--warning) !important;
        }

        /* Priority Badges */
        .priority-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 600;
            margin-right: 8px;
        }

        .priority-high {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
            box-shadow: 0 4px 15px rgba(239, 68, 68, 0.3);
        }

        .priority-medium {
            background: var(--gold-gradient);
            color: white;
            box-shadow: 0 4px 15px rgba(245, 158, 11, 0.3);
        }

        .priority-low {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
        }

        /* Budget Alert */
        .budget-alert {
            background: linear-gradient(135deg, #f72585, #f8961e);
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: none;
            animation: pulse 2s infinite;
        }

        .budget-alert.show {
            display: block;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.8;
            }
        }

        /* Statistics Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            padding: 25px;
            border-radius: 20px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.5);
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(102, 126, 234, 0.2);
        }

        .stat-value {
            font-size: 2.5rem;
            font-weight: 800;
            background: var(--premium-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin: 15px 0;
            letter-spacing: -1px;
        }

        .stat-label {
            color: var(--gray);
            font-size: 0.9rem;
        }

        /* Toast Notifications */
        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: #2d2d2d;
            color: white;
            padding: 15px 25px;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            z-index: 3000;
            display: none;
            animation: slideUp 0.3s ease;
        }

        .toast.show {
            display: block;
        }

        @keyframes slideUp {
            from {
                transform: translateX(-50%) translateY(100px);
                opacity: 0;
            }

            to {
                transform: translateX(-50%) translateY(0);
                opacity: 1;
            }
        }

        /* Keyboard Shortcuts Help */
        .shortcuts-help {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(30px);
            padding: 40px;
            border-radius: 24px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            z-index: 2000;
            display: none;
            max-width: 500px;
            width: 90%;
            border: 1px solid rgba(255, 255, 255, 0.5);
        }

        .shortcuts-help.show {
            display: block;
        }

        .shortcut-item {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid rgba(102, 126, 234, 0.1);
        }

        .shortcut-key {
            background: var(--dark);
            color: white;
            padding: 6px 12px;
            border-radius: 8px;
            font-family: monospace;
            font-size: 0.85rem;
            font-weight: 600;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.15);
        }

        @media (max-width: 768px) {

            .dashboard,
            .shift-info {
                grid-template-columns: 1fr;
            }

            .header-content {
                flex-direction: column;
                text-align: center;
            }

            .expense-categories {
                grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            }

            .shift-controls,
            .salary-controls {
                flex-direction: column;
            }

            .categories {
                flex-wrap: nowrap;
                overflow-x: auto;
            }

            .fab {
                bottom: 20px;
                right: 20px;
                width: 50px;
                height: 50px;
                font-size: 20px;
            }

            .task-details-actions {
                flex-direction: column;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <header>
            <div class="header-content">
                <div>
                    <h1>iManager</h1>
                    <p class="subtitle">My personal monthly manager</p>
                </div>
                <div style="display: flex; align-items: center; gap: 15px;">
                    <p id="current-date" style="font-weight: 500; font-size: 0.95rem;">Loading date...</p>
                    <button class="btn btn-success" id="export-data-btn" title="Export Data"
                        style="padding: 10px 18px;">
                        <i class="fas fa-download"></i>
                    </button>
                    <button class="btn btn-warning" id="import-data-btn" title="Import Data"
                        style="padding: 10px 18px;">
                        <i class="fas fa-upload"></i>
                    </button>
                    <input type="file" id="import-file-input" accept=".json" style="display: none;">
                </div>
            </div>
        </header>

        <div class="month-selector">
            <label for="month-select">Viewing:</label>
            <select id="month-select">
                <!-- Months will be populated dynamically -->
            </select>
            <button class="btn btn-primary" id="new-month-btn">Start New Month</button>
        </div>

        <div class="dashboard">
            <div class="card">
                <h2>Salary Overview - <span id="current-month"></span></h2>
                <div class="salary-summary">
                    <div class="salary-item">
                        <div class="salary-value" id="current-balance">₽0</div>
                        <div class="salary-label">Current Balance</div>
                    </div>
                    <div class="salary-item">
                        <div class="salary-value" id="monthly-income">₽0</div>
                        <div class="salary-label">Monthly Income</div>
                    </div>
                    <div class="salary-item">
                        <div class="salary-value" id="total-expenses">₽0</div>
                        <div class="salary-label">Total Expenses</div>
                    </div>
                </div>
                <div class="progress-bar">
                    <div class="progress" id="salary-progress" style="width: 0%"></div>
                </div>
                <p>Monthly budget usage: <span id="budget-usage">0%</span></p>

                <div class="shift-info">
                    <div class="shift-summary">
                        <div class="shift-value" id="shifts-worked">0</div>
                        <div class="salary-label">Shifts Worked</div>
                    </div>
                    <div class="shift-summary">
                        <div class="shift-value" id="shift-cost">₽0</div>
                        <div class="salary-label">Shift Cost</div>
                    </div>
                </div>
            </div>

            <div class="card">
                <h2>Quick Actions</h2>
                <div class="form-group">
                    <button class="btn btn-primary" id="add-task-btn">Add New Task</button>
                    <button class="btn btn-success" id="add-expense-btn">Add Expense</button>
                    <button class="btn btn-primary" id="add-note-btn">Add Note</button>
                </div>
                <div class="form-group">
                    <label for="salary-input">Update Monthly Salary</label>
                    <input type="number" id="salary-input" placeholder="Enter amount (can be negative)">
                    <div class="salary-controls">
                        <button class="btn btn-primary" id="add-salary-btn">Add Amount</button>
                        <button class="btn btn-danger" id="subtract-salary-btn">Subtract Amount</button>
                    </div>
                </div>
                <div class="form-group">
                    <label for="shift-cost-input">Shift Cost</label>
                    <input type="number" id="shift-cost-input" placeholder="Cost per shift">
                    <button class="btn btn-primary" id="update-shift-cost-btn"
                        style="margin-top: 10px; width: 100%;">Update</button>
                </div>
                <div class="form-group">
                    <label>Manage Shifts</label>
                    <div class="shift-controls">
                        <button class="btn btn-success" id="add-shift-btn">+1 Shift</button>
                        <button class="btn btn-danger" id="remove-shift-btn">-1 Shift</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="tabs">
            <div class="tab active" data-tab="tasks">Tasks</div>
            <div class="tab" data-tab="expenses">Expenses</div>
            <div class="tab" data-tab="notes">Notes</div>
            <div class="tab" data-tab="salary">Salary Details</div>
        </div>

        <div class="tab-content active" id="tasks-tab">
            <div class="card" style="padding: 0; overflow: hidden;">
                <div class="tasks-header">
                    <div class="greeting" id="time-greeting">Good evening, Mahmoud</div>
                    <div class="time-left" id="time-left">7 hours left in the day. Use them wisely!</div>

                    <div class="progress-container">
                        <div class="progress-percent" id="task-progress-percent">30%</div>
                        <div class="progress-text" id="task-progress-text">You've completed 0 out of 0 tasks.</div>
                        <div class="progress-bar-task">
                            <div class="progress-fill" id="task-progress-fill"></div>
                        </div>
                        <div class="progress-text">You're making good progress.</div>
                    </div>

                    <div class="search-container">
                        <i class="fas fa-search"></i>
                        <input type="text" id="task-search"
                            placeholder="Search tasks... (Time is like a sword, if you don't cut it, it cuts you)">
                    </div>

                    <div class="categories" id="category-filters">
                        <div class="category-chip active" data-category="all">All</div>
                        <div class="category-chip" data-category="work">Work</div>
                        <div class="category-chip" data-category="coding">Coding</div>
                        <div class="category-chip" data-category="personal">Personal</div>
                        <div class="category-chip" data-category="shopping">Shopping</div>
                        <div class="category-chip" data-category="health">Health</div>
                        <div class="category-chip" data-category="home">Home</div>
                    </div>
                </div>

                <div style="padding: 0 20px;">
                    <div class="task-form" id="task-form" style="display: none;">
                        <h3>Create New Task</h3>
                        <div class="form-group">
                            <label for="task-title">Task Title</label>
                            <input type="text" id="task-title" placeholder="Enter task title">
                        </div>
                        <div class="form-group">
                            <label for="task-description">Description (Optional)</label>
                            <textarea id="task-description" placeholder="Enter task description"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="task-category-input">Category</label>
                            <select id="task-category-input">
                                <option value="work">Work</option>
                                <option value="coding">Coding</option>
                                <option value="personal">Personal</option>
                                <option value="shopping">Shopping</option>
                                <option value="health">Health/Fitness</option>
                                <option value="home">Home</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="task-deadline-input">Deadline (Optional)</label>
                            <input type="date" id="task-deadline-input">
                        </div>
                        <div class="form-group">
                            <label for="task-priority-input">Priority</label>
                            <select id="task-priority-input">
                                <option value="low">Low</option>
                                <option value="medium" selected>Medium</option>
                                <option value="high">High</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="task-pinned-input"> Pin this task
                            </label>
                        </div>
                        <div class="form-group">
                            <button class="btn btn-primary" id="save-task-btn">Save Task</button>
                            <button class="btn btn-danger" id="cancel-task-btn">Cancel</button>
                        </div>
                    </div>



                    <div class="section-title">
                        <h3>+ Pinned</h3>
                    </div>

                    <div id="pinned-tasks-list">
                        <!-- Pinned tasks will appear here -->
                    </div>

                    <div class="section-title">
                        <h3>Today</h3>
                    </div>

                    <div id="today-tasks-list">
                        <!-- Today's tasks will appear here -->
                    </div>

                    <div class="section-title">
                        <h3>Upcoming</h3>
                    </div>

                    <div id="upcoming-tasks-list">
                        <!-- Upcoming tasks will appear here -->
                    </div>

                    <div class="completed-section">
                        <div class="section-title">
                            <h3>Completed Tasks</h3>
                        </div>

                        <div id="completed-tasks-list">
                            <!-- Completed tasks will appear here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="tab-content" id="expenses-tab">
            <div class="card">
                <h2>Expense Tracker - <span id="expense-month"></span></h2>
                <div class="form-group">
                    <label for="expense-name">Expense Name</label>
                    <input type="text" id="expense-name" placeholder="e.g., Groceries, Rent, etc.">
                </div>
                <div class="form-group">
                    <label for="expense-amount">Amount</label>
                    <input type="number" id="expense-amount" placeholder="Enter amount">
                </div>
                <div class="form-group">
                    <label for="expense-category">Category</label>
                    <select id="expense-category">
                        <option value="rent">Rent</option>
                        <option value="food">Food</option>
                        <option value="transport">Transport</option>
                        <option value="internet">Internet</option>
                        <option value="haircut">Haircut</option>
                        <option value="entertainment">Entertainment</option>
                        <option value="health">Health</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="expense-recurring"> Recurring Expense (Monthly)
                    </label>
                </div>
                <button class="btn btn-primary" id="add-expense">
                    <span id="add-expense-text">Add Expense</span>
                    <span id="add-expense-spinner" class="loading-spinner"
                        style="display: none; margin-left: 10px;"></span>
                </button>

                <div class="expense-list" id="expense-list">
                    <!-- Expenses will be added here dynamically -->
                </div>
            </div>
        </div>

        <div class="tab-content" id="notes-tab">
            <div class="card">
                <h2>Personal Notes</h2>
                <div class="form-group">
                    <label for="note-title">Title</label>
                    <input type="text" id="note-title" placeholder="Note title">
                </div>
                <div class="form-group">
                    <label for="note-content">Content</label>
                    <textarea id="note-content" placeholder="Write your note here..."></textarea>
                </div>
                <button class="btn btn-primary" id="add-note">Add Note</button>

                <div class="notes-list" id="notes-list">
                    <!-- Notes will be added here dynamically -->
                </div>
            </div>
        </div>

        <div class="tab-content" id="salary-tab">
            <div class="card">
                <h2>Salary Details - <span id="salary-month"></span></h2>

                <div class="budget-alert" id="budget-alert">
                    <strong><i class="fas fa-exclamation-triangle"></i> Budget Alert!</strong>
                    <p id="budget-alert-text">You're approaching your budget limit!</p>
                </div>

                <div class="stats-grid" id="stats-grid">
                    <!-- Statistics will be added here -->
                </div>

                <button class="download-btn" id="download-excel">
                    <i class="fas fa-file-excel"></i> Download Monthly Salary Details (Excel)
                </button>

                <div class="form-group">
                    <h3>Expense Categories</h3>
                    <div class="expense-categories" id="expense-categories">
                        <!-- Expense categories will be added here dynamically -->
                    </div>
                </div>

                <div class="form-group">
                    <h3>Expense Analytics</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px;">
                        <div class="card" style="padding: 20px;">
                            <h4 style="margin-bottom: 15px; color: var(--primary);">Category Distribution</h4>
                            <div class="chart-container">
                                <canvas id="expense-pie-chart"></canvas>
                            </div>
                        </div>
                        <div class="card" style="padding: 20px;">
                            <h4 style="margin-bottom: 15px; color: var(--primary);">Monthly Trend</h4>
                            <div class="chart-container">
                                <canvas id="expense-bar-chart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <h3>Recent Expenses</h3>
                    <div class="expense-list" id="recent-expenses">
                        <!-- Recent expenses will be added here dynamically -->
                    </div>
                </div>

                <div class="monthly-history">
                    <h3>Monthly History</h3>
                    <div id="monthly-history-list">
                        <!-- Monthly history will be added here dynamically -->
                    </div>
                </div>
            </div>
        </div>

        <!-- NEW: Floating Action Button for Adding Tasks -->
        <div class="fab" id="fab-add-task">
            <i class="fas fa-plus"></i>
        </div>

        <!-- Toast Notification -->
        <div class="toast" id="toast">
            <span id="toast-message"></span>
        </div>

        <!-- Auto-save Indicator -->
        <div class="save-indicator" id="save-indicator">
            <i class="fas fa-check-circle"></i> Saved
        </div>

        <!-- Keyboard Shortcuts Help -->
        <div class="shortcuts-help" id="shortcuts-help">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2>Keyboard Shortcuts</h2>
                <button class="task-details-close" id="close-shortcuts">&times;</button>
            </div>
            <div class="shortcut-item">
                <span>Add New Task</span>
                <span class="shortcut-key">Ctrl + N</span>
            </div>
            <div class="shortcut-item">
                <span>Add Expense</span>
                <span class="shortcut-key">Ctrl + E</span>
            </div>
            <div class="shortcut-item">
                <span>Add Note</span>
                <span class="shortcut-key">Ctrl + M</span>
            </div>
            <div class="shortcut-item">
                <span>Search Tasks</span>
                <span class="shortcut-key">Ctrl + F</span>
            </div>
            <div class="shortcut-item">
                <span>Show Shortcuts</span>
                <span class="shortcut-key">?</span>
            </div>
        </div>

        <!-- NEW: Task Details Modal -->
        <div class="task-details-modal" id="task-details-modal">
            <div class="task-details-content">
                <div class="task-details-header">
                    <h2 class="task-details-title" id="task-details-title">Task Details</h2>
                    <button class="task-details-close" id="task-details-close">&times;</button>
                </div>
                <div class="task-details-body">
                    <div class="task-details-description" id="task-details-description">
                        No description available.
                    </div>
                    <div class="task-details-meta">
                        <div class="task-details-meta-item">
                            <i class="fas fa-tag"></i>
                            <span id="task-details-category">Category</span>
                        </div>
                        <div class="task-details-meta-item">
                            <i class="far fa-calendar"></i>
                            <span id="task-details-deadline">No deadline</span>
                        </div>
                        <div class="task-details-meta-item">
                            <i class="fas fa-thumbtack"></i>
                            <span id="task-details-pinned">Not pinned</span>
                        </div>
                        <div class="task-details-meta-item">
                            <i class="far fa-check-circle"></i>
                            <span id="task-details-status">Status</span>
                        </div>
                    </div>
                </div>
                <div class="task-details-actions">
                    <button class="task-details-action-btn task-details-complete" id="task-details-complete">
                        <i class="far fa-check-circle"></i> Mark as Done
                    </button>
                    <button class="task-details-action-btn task-details-pin" id="task-details-pin">
                        <i class="fas fa-thumbtack"></i> Pin/Unpin
                    </button>
                    <button class="task-details-action-btn task-details-edit" id="task-details-edit">
                        <i class="far fa-edit"></i> Edit
                    </button>
                    <button class="task-details-action-btn task-details-delete" id="task-details-delete">
                        <i class="far fa-trash-alt"></i> Delete
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Initialize data with localStorage
        let monthlyData = JSON.parse(localStorage.getItem('iManager_monthlyData')) || {};
        let notes = JSON.parse(localStorage.getItem('iManager_notes')) || [];
        let currentMonth = getCurrentMonthKey();

        // Initialize current month if it doesn't exist
        if (!monthlyData[currentMonth]) {
            monthlyData[currentMonth] = {
                tasks: [],
                expenses: [],
                monthlySalary: 0,
                shiftCost: 0,
                shiftsWorked: 0
            };
            saveData();
        }

        // DOM Elements
        const currentDateEl = document.getElementById('current-date');
        const currentMonthEl = document.getElementById('current-month');
        const expenseMonthEl = document.getElementById('expense-month');
        const salaryMonthEl = document.getElementById('salary-month');
        const currentBalanceEl = document.getElementById('current-balance');
        const monthlyIncomeEl = document.getElementById('monthly-income');
        const totalExpensesEl = document.getElementById('total-expenses');
        const salaryProgressEl = document.getElementById('salary-progress');
        const budgetUsageEl = document.getElementById('budget-usage');
        const shiftsWorkedEl = document.getElementById('shifts-worked');
        const shiftCostEl = document.getElementById('shift-cost');
        const expenseListEl = document.getElementById('expense-list');
        const notesListEl = document.getElementById('notes-list');
        const expenseCategoriesEl = document.getElementById('expense-categories');
        const recentExpensesEl = document.getElementById('recent-expenses');
        const monthlyHistoryEl = document.getElementById('monthly-history-list');
        const monthSelectEl = document.getElementById('month-select');
        const tabs = document.querySelectorAll('.tab');
        const tabContents = document.querySelectorAll('.tab-content');

        // Task-related DOM elements
        const pinnedTasksListEl = document.getElementById('pinned-tasks-list');
        const todayTasksListEl = document.getElementById('today-tasks-list');
        const upcomingTasksListEl = document.getElementById('upcoming-tasks-list');
        const completedTasksListEl = document.getElementById('completed-tasks-list');
        const taskFormEl = document.getElementById('task-form');
        const taskTitleInput = document.getElementById('task-title');
        const taskDescriptionInput = document.getElementById('task-description');
        const taskCategoryInput = document.getElementById('task-category-input');
        const taskDeadlineInput = document.getElementById('task-deadline-input');
        const taskPinnedInput = document.getElementById('task-pinned-input');
        const saveTaskBtn = document.getElementById('save-task-btn');
        const cancelTaskBtn = document.getElementById('cancel-task-btn');

        // NEW: Task-related DOM elements
        const fabAddTaskEl = document.getElementById('fab-add-task');
        const taskDetailsModalEl = document.getElementById('task-details-modal');
        const taskDetailsCloseEl = document.getElementById('task-details-close');
        const taskDetailsTitleEl = document.getElementById('task-details-title');
        const taskDetailsDescriptionEl = document.getElementById('task-details-description');
        const taskDetailsCategoryEl = document.getElementById('task-details-category');
        const taskDetailsDeadlineEl = document.getElementById('task-details-deadline');
        const taskDetailsPinnedEl = document.getElementById('task-details-pinned');
        const taskDetailsStatusEl = document.getElementById('task-details-status');
        const taskDetailsCompleteEl = document.getElementById('task-details-complete');
        const taskDetailsPinEl = document.getElementById('task-details-pin');
        const taskDetailsEditEl = document.getElementById('task-details-edit');
        const taskDetailsDeleteEl = document.getElementById('task-details-delete');

        // Variable to track the currently selected task
        let currentTaskId = null;

        // Filter state
        let currentSearchQuery = '';
        let currentCategoryFilter = 'all';

        // Category icons mapping
        const categoryIcons = {
            'rent': 'fa-home',
            'food': 'fa-utensils',
            'transport': 'fa-car',
            'internet': 'fa-wifi',
            'haircut': 'fa-cut',
            'entertainment': 'fa-film',
            'health': 'fa-heartbeat',
            'other': 'fa-receipt'
        };

        // Task category colors
        const taskCategoryColors = {
            'work': '#4361ee',
            'personal': '#f72585',
            'shopping': '#4cc9f0',
            'health': '#f8961e',
            'other': '#6c757d',
            'coding': '#4361ee',
            'home': '#4cc9f0',
            'health/fitness': '#f8961e'
        };

        // Priority colors
        const priorityColors = {
            'high': '#f72585',
            'medium': '#f8961e',
            'low': '#4cc9f0'
        };

        // Helper functions
        function getCurrentMonthKey() {
            const now = new Date();
            return `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
        }

        function formatMonthKey(key) {
            const [year, month] = key.split('-');
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                'July', 'August', 'September', 'October', 'November', 'December'];
            return `${monthNames[parseInt(month) - 1]} ${year}`;
        }

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function () {
            // Set current date
            const now = new Date();
            currentDateEl.textContent = now.toLocaleDateString('en-US', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });

            // Update month displays
            currentMonthEl.textContent = formatMonthKey(currentMonth);
            expenseMonthEl.textContent = formatMonthKey(currentMonth);
            salaryMonthEl.textContent = formatMonthKey(currentMonth);

            // Populate month selector
            populateMonthSelector();

            // Update salary display
            updateSalaryDisplay();

            // Render all data
            renderTasks();
            renderExpenses();
            renderNotes();
            renderExpenseCategories();
            renderRecentExpenses();
            renderMonthlyHistory();
            renderStatistics();
            renderExpenseCharts();

            // Set up event listeners
            setupEventListeners();
        });

        // Set up event listeners
        function setupEventListeners() {
            // Add task button
            document.getElementById('add-task-btn').addEventListener('click', function () {
                switchTab('tasks');
                showTaskForm();
            });

            // Save task
            saveTaskBtn.addEventListener('click', saveTask);

            // Cancel task creation
            cancelTaskBtn.addEventListener('click', hideTaskForm);

            // Add expense
            document.getElementById('add-expense').addEventListener('click', addExpense);

            // Add note
            document.getElementById('add-note').addEventListener('click', addNote);

            // Update salary
            document.getElementById('add-salary-btn').addEventListener('click', function () {
                updateSalary('add');
            });
            document.getElementById('subtract-salary-btn').addEventListener('click', function () {
                updateSalary('subtract');
            });

            // Update shift cost
            document.getElementById('update-shift-cost-btn').addEventListener('click', updateShiftCost);

            // Add/remove shift worked
            document.getElementById('add-shift-btn').addEventListener('click', function () {
                updateShiftsWorked(1);
            });
            document.getElementById('remove-shift-btn').addEventListener('click', function () {
                updateShiftsWorked(-1);
            });

            // Quick action buttons
            document.getElementById('add-expense-btn').addEventListener('click', function () {
                switchTab('expenses');
                document.getElementById('expense-name').focus();
            });

            document.getElementById('add-note-btn').addEventListener('click', function () {
                switchTab('notes');
                document.getElementById('note-title').focus();
            });

            // Month selector
            monthSelectEl.addEventListener('change', changeMonth);
            document.getElementById('new-month-btn').addEventListener('click', startNewMonth);

            // Tab switching
            tabs.forEach(tab => {
                tab.addEventListener('click', function () {
                    const tabId = this.getAttribute('data-tab');
                    switchTab(tabId);
                });
            });

            // Task search
            document.getElementById('task-search').addEventListener('input', function (e) {
                currentSearchQuery = e.target.value.toLowerCase();
                renderTasks();
            });

            // Category filter chips
            document.querySelectorAll('.category-chip').forEach(chip => {
                chip.addEventListener('click', function () {
                    document.querySelectorAll('.category-chip').forEach(c => c.classList.remove('active'));
                    this.classList.add('active');
                    currentCategoryFilter = this.getAttribute('data-category');
                    renderTasks();
                });
            });

            // Export/Import data
            document.getElementById('export-data-btn').addEventListener('click', exportData);
            document.getElementById('import-data-btn').addEventListener('click', () => {
                document.getElementById('import-file-input').click();
            });
            document.getElementById('import-file-input').addEventListener('change', importData);

            // Keyboard shortcuts
            document.addEventListener('keydown', handleKeyboardShortcuts);

            // Close shortcuts help
            document.getElementById('close-shortcuts').addEventListener('click', () => {
                document.getElementById('shortcuts-help').classList.remove('show');
            });

            // Download Excel button
            document.getElementById('download-excel').addEventListener('click', downloadSalaryExcel);

            // Print functionality
            document.addEventListener('keydown', (e) => {
                if ((e.ctrlKey || e.metaKey) && e.key === 'p') {
                    e.preventDefault();
                    window.print();
                }
            });

            // NEW: FAB Add Task button
            fabAddTaskEl.addEventListener('click', function () {
                switchTab('tasks');
                showTaskForm();
            });

            // NEW: Task details modal close button
            taskDetailsCloseEl.addEventListener('click', closeTaskDetails);

            // NEW: Task details action buttons
            taskDetailsCompleteEl.addEventListener('click', function () {
                if (currentTaskId) {
                    toggleTask(currentTaskId);
                    closeTaskDetails();
                }
            });

            taskDetailsPinEl.addEventListener('click', function () {
                if (currentTaskId) {
                    togglePinTask(currentTaskId);
                    closeTaskDetails();
                }
            });

            taskDetailsEditEl.addEventListener('click', function () {
                if (currentTaskId) {
                    editTask(currentTaskId);
                    closeTaskDetails();
                }
            });

            taskDetailsDeleteEl.addEventListener('click', function () {
                if (currentTaskId) {
                    deleteTask(currentTaskId);
                    closeTaskDetails();
                }
            });

            // NEW: Close modal when clicking outside
            taskDetailsModalEl.addEventListener('click', function (e) {
                if (e.target === taskDetailsModalEl) {
                    closeTaskDetails();
                }
            });
        }

        // NEW: Function to open task details
        function openTaskDetails(taskId) {
            const task = monthlyData[currentMonth].tasks.find(t => t.id === taskId);
            if (!task) return;

            currentTaskId = taskId;

            // Update modal content
            taskDetailsTitleEl.textContent = task.text;
            taskDetailsDescriptionEl.textContent = task.description || 'No description available.';
            taskDetailsCategoryEl.textContent = task.category.charAt(0).toUpperCase() + task.category.slice(1);

            // Add priority info if available
            if (task.priority) {
                const priorityName = task.priority.charAt(0).toUpperCase() + task.priority.slice(1);
                taskDetailsCategoryEl.textContent += ` • Priority: ${priorityName}`;
            }

            if (task.deadline) {
                const deadlineDate = new Date(task.deadline);
                taskDetailsDeadlineEl.textContent = deadlineDate.toLocaleDateString('en-GB');
            } else {
                taskDetailsDeadlineEl.textContent = 'No deadline';
            }

            taskDetailsPinnedEl.textContent = task.pinned ? 'Pinned' : 'Not pinned';
            taskDetailsStatusEl.textContent = task.completed ? 'Completed' : 'Incomplete';

            // Update button text based on task status
            taskDetailsCompleteEl.innerHTML = task.completed ?
                '<i class="fas fa-redo"></i> Reopen' :
                '<i class="far fa-check-circle"></i> Mark as Done';

            taskDetailsPinEl.innerHTML = task.pinned ?
                '<i class="fas fa-thumbtack"></i> Unpin' :
                '<i class="fas fa-thumbtack"></i> Pin';

            // Show modal
            taskDetailsModalEl.style.display = 'flex';
        }

        // NEW: Function to close task details
        function closeTaskDetails() {
            taskDetailsModalEl.style.display = 'none';
            currentTaskId = null;
        }

        // Task form functions
        function showTaskForm() {
            taskFormEl.style.display = 'block';
            // Set today's date as default for deadline
            const today = new Date().toISOString().split('T')[0];
            taskDeadlineInput.value = today;
            taskTitleInput.focus();
        }

        function hideTaskForm() {
            taskFormEl.style.display = 'none';
            // Reset form
            taskTitleInput.value = '';
            taskDescriptionInput.value = '';
            taskCategoryInput.value = 'work';
            taskDeadlineInput.value = '';
            taskPinnedInput.checked = false;
            document.getElementById('task-priority-input').value = 'medium';
        }

        function saveTask() {
            const title = taskTitleInput.value.trim();
            const description = taskDescriptionInput.value.trim();
            const category = taskCategoryInput.value;
            const deadline = taskDeadlineInput.value;
            const pinned = taskPinnedInput.checked;

            if (title) {
                const priority = document.getElementById('task-priority-input').value;
                const task = {
                    id: Date.now(),
                    text: title,
                    description: description,
                    category: category,
                    deadline: deadline,
                    pinned: pinned,
                    priority: priority,
                    completed: false,
                    createdAt: new Date().toISOString()
                };

                monthlyData[currentMonth].tasks.push(task);
                saveData();
                renderTasks();
                hideTaskForm();
            } else {
                alert('Please enter a task title');
            }
        }

        // Tab switching function
        function switchTab(tabId) {
            // Remove active class from all tabs and contents
            tabs.forEach(tab => tab.classList.remove('active'));
            tabContents.forEach(content => content.classList.remove('active'));

            // Add active class to selected tab and content
            document.querySelector(`.tab[data-tab="${tabId}"]`).classList.add('active');
            document.getElementById(`${tabId}-tab`).classList.add('active');
        }

        // Populate month selector
        function populateMonthSelector() {
            monthSelectEl.innerHTML = '';

            const months = Object.keys(monthlyData).sort().reverse();

            months.forEach(month => {
                const option = document.createElement('option');
                option.value = month;
                option.textContent = formatMonthKey(month);
                if (month === currentMonth) {
                    option.selected = true;
                }
                monthSelectEl.appendChild(option);
            });
        }

        // Change current month
        function changeMonth() {
            currentMonth = monthSelectEl.value;
            currentMonthEl.textContent = formatMonthKey(currentMonth);
            expenseMonthEl.textContent = formatMonthKey(currentMonth);
            salaryMonthEl.textContent = formatMonthKey(currentMonth);

            updateSalaryDisplay();
            renderTasks();
            renderExpenses();
            renderExpenseCategories();
            renderRecentExpenses();
            renderExpenseCharts();
        }

        // Start a new month
        function startNewMonth() {
            const now = new Date();
            const nextMonth = new Date(now.getFullYear(), now.getMonth() + 1, 1);
            const nextMonthKey = `${nextMonth.getFullYear()}-${String(nextMonth.getMonth() + 1).padStart(2, '0')}`;

            if (!monthlyData[nextMonthKey]) {
                monthlyData[nextMonthKey] = {
                    tasks: [],
                    expenses: [],
                    monthlySalary: monthlyData[currentMonth].monthlySalary,
                    shiftCost: monthlyData[currentMonth].shiftCost,
                    shiftsWorked: 0
                };
                saveData();

                currentMonth = nextMonthKey;
                populateMonthSelector();
                changeMonth();
            } else {
                showToast('Next month already exists!', 'warning');
            }
        }

        // Update salary display
        function updateSalaryDisplay() {
            const data = monthlyData[currentMonth];

            // Calculate income from shifts if shift cost is set
            const incomeFromShifts = data.shiftCost * data.shiftsWorked;
            const totalIncome = data.monthlySalary + incomeFromShifts;

            monthlyIncomeEl.textContent = `₽${totalIncome.toLocaleString()}`;

            const totalExpenses = data.expenses.reduce((sum, expense) => sum + parseFloat(expense.amount), 0);
            totalExpensesEl.textContent = `₽${totalExpenses.toLocaleString()}`;

            const currentBalance = totalIncome - totalExpenses;
            currentBalanceEl.textContent = `₽${currentBalance.toLocaleString()}`;

            // Update shift information
            shiftsWorkedEl.textContent = data.shiftsWorked;
            shiftCostEl.textContent = `₽${data.shiftCost.toLocaleString()}`;

            // Update progress bar
            if (totalIncome > 0) {
                const usagePercentage = (totalExpenses / totalIncome) * 100;
                salaryProgressEl.style.width = `${Math.min(usagePercentage, 100)}%`;
                budgetUsageEl.textContent = `${usagePercentage.toFixed(1)}%`;

                // Change color based on usage
                if (usagePercentage > 90) {
                    salaryProgressEl.style.background = 'linear-gradient(135deg, #d32f2f 0%, #f44336 100%)';
                } else if (usagePercentage > 70) {
                    salaryProgressEl.style.background = 'var(--gold-gradient)';
                } else {
                    salaryProgressEl.style.background = 'linear-gradient(135deg, #00c853 0%, #4caf50 100%)';
                }

                // Show budget alert
                checkBudgetAlert(usagePercentage, totalIncome, totalExpenses);
            } else {
                salaryProgressEl.style.width = '0%';
                budgetUsageEl.textContent = '0%';
                document.getElementById('budget-alert').classList.remove('show');
            }
        }

        // Check and show budget alerts
        function checkBudgetAlert(usagePercentage, totalIncome, totalExpenses) {
            const alertEl = document.getElementById('budget-alert');
            const alertTextEl = document.getElementById('budget-alert-text');

            if (usagePercentage >= 90) {
                alertTextEl.textContent = `You've used ${usagePercentage.toFixed(1)}% of your budget! Only ₽${(totalIncome - totalExpenses).toLocaleString()} remaining.`;
                alertEl.classList.add('show');
            } else if (usagePercentage >= 70) {
                alertTextEl.textContent = `You've used ${usagePercentage.toFixed(1)}% of your budget. Be careful with spending!`;
                alertEl.classList.add('show');
            } else {
                alertEl.classList.remove('show');
            }
        }

        // Task functions
        function updateTaskProgress() {
            const data = monthlyData[currentMonth];
            const totalTasks = data.tasks.length;
            const completedTasks = data.tasks.filter(task => task.completed).length;

            if (totalTasks > 0) {
                const progressPercent = Math.round((completedTasks / totalTasks) * 100);
                document.getElementById('task-progress-percent').textContent = `${progressPercent}%`;
                document.getElementById('task-progress-text').textContent =
                    `You've completed ${completedTasks} out of ${totalTasks} tasks.`;
                document.getElementById('task-progress-fill').style.width = `${progressPercent}%`;

                // Update greeting based on time of day
                updateGreeting();
            } else {
                document.getElementById('task-progress-percent').textContent = `0%`;
                document.getElementById('task-progress-text').textContent =
                    `You have no tasks yet. Add your first task!`;
                document.getElementById('task-progress-fill').style.width = `0%`;
            }
        }

        function updateGreeting() {
            const now = new Date();
            const hour = now.getHours();
            let greeting = "Good evening";

            if (hour < 12) greeting = "Good morning";
            else if (hour < 18) greeting = "Good afternoon";

            document.getElementById('time-greeting').textContent = `${greeting}, Mahmoud`;

            // Calculate hours left in the day
            const hoursLeft = 24 - hour;
            document.getElementById('time-left').textContent =
                `${hoursLeft} hours left in the day. Use them wisely!`;
        }

        // Render tasks in the new design
        function renderTasks() {
            const data = monthlyData[currentMonth];

            // Apply filters
            let filteredTasks = data.tasks;

            // Apply search filter
            if (currentSearchQuery) {
                filteredTasks = filteredTasks.filter(task =>
                    task.text.toLowerCase().includes(currentSearchQuery) ||
                    (task.description && task.description.toLowerCase().includes(currentSearchQuery)) ||
                    task.category.toLowerCase().includes(currentSearchQuery)
                );
            }

            // Apply category filter
            if (currentCategoryFilter !== 'all') {
                filteredTasks = filteredTasks.filter(task => task.category === currentCategoryFilter);
            }

            const pinnedTasks = filteredTasks.filter(task => task.pinned && !task.completed);
            const todayTasks = filteredTasks.filter(task => !task.pinned && !task.completed && isToday(task.deadline));
            const upcomingTasks = filteredTasks.filter(task => !task.pinned && !task.completed && !isToday(task.deadline) && task.deadline);
            const completedTasks = filteredTasks.filter(task => task.completed);

            // Render pinned tasks
            pinnedTasksListEl.innerHTML = '';

            if (pinnedTasks.length === 0) {
                pinnedTasksListEl.innerHTML = '<div class="empty-state"><i class="fas fa-thumbtack"></i><p>No pinned tasks</p></div>';
            } else {
                pinnedTasks.forEach(task => {
                    const taskEl = createNewTaskElement(task);
                    pinnedTasksListEl.appendChild(taskEl);
                });
            }

            // Render today's tasks
            todayTasksListEl.innerHTML = '';

            if (todayTasks.length === 0) {
                todayTasksListEl.innerHTML = '<div class="empty-state"><i class="far fa-calendar"></i><p>No tasks for today</p></div>';
            } else {
                todayTasks.forEach(task => {
                    const taskEl = createNewTaskElement(task);
                    todayTasksListEl.appendChild(taskEl);
                });
            }

            // Render upcoming tasks
            upcomingTasksListEl.innerHTML = '';

            if (upcomingTasks.length === 0) {
                upcomingTasksListEl.innerHTML = '<div class="empty-state"><i class="far fa-check-circle"></i><p>No upcoming tasks. Add a new task to get started!</p></div>';
            } else {
                upcomingTasks.forEach(task => {
                    const taskEl = createNewTaskElement(task);
                    upcomingTasksListEl.appendChild(taskEl);
                });
            }

            // Render completed tasks
            completedTasksListEl.innerHTML = '';

            if (completedTasks.length === 0) {
                completedTasksListEl.innerHTML = '<div class="empty-state"><i class="far fa-check-circle"></i><p>No completed tasks yet</p></div>';
            } else {
                completedTasks.forEach(task => {
                    const taskEl = createNewTaskElement(task);
                    completedTasksListEl.appendChild(taskEl);
                });
            }

            // Update task progress
            updateTaskProgress();

            // Update statistics if on salary tab
            if (document.getElementById('stats-grid')) renderStatistics();
        }

        function createNewTaskElement(task) {
            const div = document.createElement('div');
            div.className = `task-item ${task.completed ? 'completed-task task-completed' : ''} ${task.pinned ? 'pinned task-pinned' : ''}`;

            // Add click event to open task details
            div.addEventListener('click', function (e) {
                // Don't open details if clicking on action buttons
                if (!e.target.closest('.task-buttons')) {
                    openTaskDetails(task.id);
                }
            });

            // Format deadline if exists
            let deadlineHtml = '';
            if (task.deadline) {
                const deadlineDate = new Date(task.deadline);
                const today = new Date();
                const tomorrow = new Date(today);
                tomorrow.setDate(tomorrow.getDate() + 1);

                let dateText = deadlineDate.toLocaleDateString('en-GB');
                if (isToday(deadlineDate)) {
                    dateText = 'Today';
                } else if (isTomorrow(deadlineDate)) {
                    dateText = 'Tomorrow';
                }

                deadlineHtml = `<div class="task-date"><i class="far fa-clock"></i> ${dateText}</div>`;
            }

            // Create category tags
            const categoryName = task.category.charAt(0).toUpperCase() + task.category.slice(1);
            const categoryColor = taskCategoryColors[task.category] || taskCategoryColors['other'];
            const categoryHtml = `<span class="task-category" style="background-color: ${categoryColor}; color: white;">${categoryName}</span>`;

            // Create priority badge
            const priority = task.priority || 'medium';
            const priorityName = priority.charAt(0).toUpperCase() + priority.slice(1);
            const priorityHtml = `<span class="priority-badge priority-${priority}">${priorityName}</span>`;

            // Create status text
            let statusHtml = '';
            if (task.completed) {
                statusHtml = '<i class="fas fa-check-circle"></i> Completed';
            } else {
                statusHtml = '<i class="far fa-check-circle"></i> Not completed';
            }

            // Create action buttons
            let actionButtons = '';
            if (task.completed) {
                actionButtons = `
                <button class="task-btn" onclick="event.stopPropagation(); reopenTask(${task.id})">
                    <i class="fas fa-redo"></i> Reopen
                </button>
            `;
            } else {
                actionButtons = `
                <button class="task-btn" onclick="event.stopPropagation(); editTask(${task.id})">
                    <i class="far fa-edit"></i> Edit
                </button>
                <button class="task-btn" onclick="event.stopPropagation(); togglePinTask(${task.id})">
                    <i class="fas fa-thumbtack"></i> ${task.pinned ? 'Unpin' : 'Pin'}
                </button>
            `;
            }

            // Add pinned badge if needed
            const pinnedBadge = task.pinned ?
                `<div class="pinned-badge"><i class="fas fa-thumbtack"></i> Pinned</div>` : '';

            div.innerHTML = `
            ${pinnedBadge}
            <div class="task-header">
                <div class="task-title">${task.text}</div>
            </div>
            ${task.description ? `<div class="task-description">${task.description}</div>` : ''}
            <div class="task-meta">
                ${priorityHtml}
                ${deadlineHtml}
                ${categoryHtml}
            </div>
            <div class="task-actions">
                <div class="task-status">
                    ${statusHtml}
                </div>
                <div class="task-buttons">
                    ${actionButtons}
                    <button class="task-btn" onclick="event.stopPropagation(); deleteTask(${task.id})">
                        <i class="far fa-trash-alt"></i> Delete
                    </button>
                </div>
            </div>
        `;

            return div;
        }

        function isToday(date) {
            if (!date) return false;
            const checkDate = new Date(date);
            const today = new Date();
            return checkDate.toDateString() === today.toDateString();
        }

        function isTomorrow(date) {
            if (!date) return false;
            const checkDate = new Date(date);
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            return checkDate.toDateString() === tomorrow.toDateString();
        }

        // Task action functions
        function toggleTask(id) {
            monthlyData[currentMonth].tasks = monthlyData[currentMonth].tasks.map(task => {
                if (task.id === id) {
                    task.completed = !task.completed;
                }
                return task;
            });

            saveData();
            renderTasks();
        }

        function reopenTask(id) {
            toggleTask(id);
        }

        function deleteTask(id) {
            monthlyData[currentMonth].tasks = monthlyData[currentMonth].tasks.filter(task => task.id !== id);
            saveData();
            renderTasks();
            showToast('Task deleted successfully');
        }

        function editTask(id) {
            const task = monthlyData[currentMonth].tasks.find(t => t.id === id);
            if (!task) return;

            // Pre-fill the task form with current values
            taskTitleInput.value = task.text;
            taskDescriptionInput.value = task.description || '';
            taskCategoryInput.value = task.category;
            taskDeadlineInput.value = task.deadline || '';
            taskPinnedInput.checked = task.pinned;
            document.getElementById('task-priority-input').value = task.priority || 'medium';

            // Show the form
            showTaskForm();

            // Update save button to edit instead of create
            saveTaskBtn.textContent = 'Update Task';
            saveTaskBtn.onclick = function () {
                updateTask(id);
            };

            // Update cancel button to reset to create mode
            cancelTaskBtn.onclick = function () {
                hideTaskForm();
                saveTaskBtn.textContent = 'Save Task';
                saveTaskBtn.onclick = saveTask;
            };
        }

        // Function to update an existing task
        function updateTask(id) {
            const title = taskTitleInput.value.trim();
            const description = taskDescriptionInput.value.trim();
            const category = taskCategoryInput.value;
            const deadline = taskDeadlineInput.value;
            const pinned = taskPinnedInput.checked;
            const priority = document.getElementById('task-priority-input').value;

            if (title) {
                monthlyData[currentMonth].tasks = monthlyData[currentMonth].tasks.map(task => {
                    if (task.id === id) {
                        task.text = title;
                        task.description = description;
                        task.category = category;
                        task.deadline = deadline;
                        task.pinned = pinned;
                        task.priority = priority;
                    }
                    return task;
                });

                saveData();
                renderTasks();
                hideTaskForm();

                // Reset save button to create mode
                saveTaskBtn.textContent = 'Save Task';
                saveTaskBtn.onclick = saveTask;
            } else {
                alert('Please enter a task title');
            }
        }

        function togglePinTask(id) {
            monthlyData[currentMonth].tasks = monthlyData[currentMonth].tasks.map(task => {
                if (task.id === id) {
                    task.pinned = !task.pinned;
                }
                return task;
            });

            saveData();
            renderTasks();
        }


        // Expense functions
        function addExpense() {
            const nameInput = document.getElementById('expense-name');
            const amountInput = document.getElementById('expense-amount');
            const categorySelect = document.getElementById('expense-category');
            const recurringCheckbox = document.getElementById('expense-recurring');
            const addBtn = document.getElementById('add-expense');
            const addBtnText = document.getElementById('add-expense-text');
            const addBtnSpinner = document.getElementById('add-expense-spinner');

            const name = nameInput.value.trim();
            const amount = parseFloat(amountInput.value);
            const category = categorySelect.value;
            const isRecurring = recurringCheckbox.checked;

            if (!name || !amount || amount <= 0) {
                showToast('Please enter a valid expense name and amount', 'error');
                return;
            }

            // Show loading state
            addBtnText.textContent = 'Adding...';
            addBtnSpinner.style.display = 'inline-block';
            addBtn.disabled = true;

            setTimeout(() => {
                const expense = {
                    id: Date.now(),
                    name: name,
                    amount: amount,
                    category: category,
                    date: new Date().toISOString(),
                    recurring: isRecurring
                };

                monthlyData[currentMonth].expenses.push(expense);
                saveData();
                renderExpenses();
                renderExpenseCategories();
                renderRecentExpenses();
                updateSalaryDisplay();
                renderExpenseCharts();

                // Reset form
                nameInput.value = '';
                amountInput.value = '';
                categorySelect.value = 'food';
                recurringCheckbox.checked = false;

                // Reset button
                addBtnText.textContent = 'Add Expense';
                addBtnSpinner.style.display = 'none';
                addBtn.disabled = false;

                showToast('Expense added successfully');
            }, 300);
        }

        function deleteExpense(id) {
            monthlyData[currentMonth].expenses = monthlyData[currentMonth].expenses.filter(expense => expense.id !== id);
            saveData();
            renderExpenses();
            renderExpenseCategories();
            renderRecentExpenses();
            updateSalaryDisplay();
        }

        function renderExpenses() {
            expenseListEl.innerHTML = '';
            const data = monthlyData[currentMonth];

            if (data.expenses.length === 0) {
                expenseListEl.innerHTML = '<p>No expenses recorded yet.</p>';
                if (document.getElementById('stats-grid')) renderStatistics();
                return;
            }

            // Show only last 10 expenses in the expense tab
            const recentExpenses = [...data.expenses].reverse().slice(0, 10);

            recentExpenses.forEach(expense => {
                const div = document.createElement('div');
                div.className = 'expense-item';

                div.innerHTML = `
                    <div style="display: flex; align-items: center;">
                        <div class="expense-icon">
                            <i class="fas ${categoryIcons[expense.category]}"></i>
                        </div>
                        <div>
                            <strong>${expense.name}</strong>
                            <br>
                            <small>${expense.category} • ${new Date(expense.date).toLocaleDateString()}</small>
                        </div>
                    </div>
                    <div class="expense-amount">₽${expense.amount.toLocaleString()}</div>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        ${expense.recurring ? '<span class="recurring-badge"><i class="fas fa-sync-alt"></i> Recurring</span>' : ''}
                        <button class="btn btn-danger" onclick="deleteExpense(${expense.id})" style="padding: 8px 15px;">Delete</button>
                    </div>
                `;

                expenseListEl.appendChild(div);
            });

            if (document.getElementById('stats-grid')) renderStatistics();
        }

        function renderExpenseCategories() {
            expenseCategoriesEl.innerHTML = '';
            const data = monthlyData[currentMonth];

            // Calculate total by category
            const categories = {};
            data.expenses.forEach(expense => {
                if (!categories[expense.category]) {
                    categories[expense.category] = 0;
                }
                categories[expense.category] += expense.amount;
            });

            // Create category items
            Object.keys(categories).forEach(category => {
                const div = document.createElement('div');
                div.className = 'category-item';

                div.innerHTML = `
                    <div class="category-icon">
                        <i class="fas ${categoryIcons[category]}"></i>
                    </div>
                    <div class="category-name">${category.charAt(0).toUpperCase() + category.slice(1)}</div>
                    <div class="category-amount">₽${categories[category].toLocaleString()}</div>
                `;

                expenseCategoriesEl.appendChild(div);
            });
        }

        function renderRecentExpenses() {
            recentExpensesEl.innerHTML = '';
            const data = monthlyData[currentMonth];

            if (data.expenses.length === 0) {
                recentExpensesEl.innerHTML = '<p>No expenses recorded yet.</p>';
                return;
            }

            // Show only last 5 expenses in the salary tab
            const recentExpenses = [...data.expenses].reverse().slice(0, 5);

            recentExpenses.forEach(expense => {
                const div = document.createElement('div');
                div.className = 'expense-item';

                div.innerHTML = `
                    <div style="display: flex; align-items: center;">
                        <div class="expense-icon">
                            <i class="fas ${categoryIcons[expense.category]}"></i>
                        </div>
                        <div>
                            <strong>${expense.name}</strong>
                            <br>
                            <small>${expense.category} • ${new Date(expense.date).toLocaleDateString()}</small>
                        </div>
                    </div>
                    <div class="expense-amount">₽${expense.amount.toLocaleString()}</div>
                    ${expense.recurring ? '<span class="recurring-badge"><i class="fas fa-sync-alt"></i> Recurring</span>' : ''}
                `;

                recentExpensesEl.appendChild(div);
            });
        }

        // Note functions
        function addNote() {
            const titleInput = document.getElementById('note-title');
            const contentInput = document.getElementById('note-content');

            const title = titleInput.value.trim();
            const content = contentInput.value.trim();

            if (title && content) {
                const note = {
                    id: Date.now(),
                    title: title,
                    content: content,
                    date: new Date().toISOString()
                };

                notes.push(note);
                saveData();
                renderNotes();

                // Reset form
                titleInput.value = '';
                contentInput.value = '';
            }
        }

        function deleteNote(id) {
            notes = notes.filter(note => note.id !== id);
            saveData();
            renderNotes();
            showToast('Note deleted successfully');
        }

        function renderNotes() {
            notesListEl.innerHTML = '';

            if (notes.length === 0) {
                notesListEl.innerHTML = '<p>No notes yet. Add your first note!</p>';
                return;
            }

            // Show notes in reverse chronological order
            const sortedNotes = [...notes].reverse();

            sortedNotes.forEach(note => {
                const div = document.createElement('div');
                div.className = 'note-item';

                div.innerHTML = `
                    <div class="note-title">${note.title}</div>
                    <div class="note-content">${note.content}</div>
                    <div class="note-date">${new Date(note.date).toLocaleDateString()}</div>
                    <button class="btn btn-danger" onclick="deleteNote(${note.id})" style="margin-top: 10px;">Delete</button>
                `;

                notesListEl.appendChild(div);
            });
        }

        // Salary and shift functions
        function updateSalary(operation) {
            const salaryInput = document.getElementById('salary-input');
            const amount = parseInt(salaryInput.value) || 0;

            if (amount !== 0) {
                if (operation === 'add') {
                    monthlyData[currentMonth].monthlySalary += amount;
                } else {
                    monthlyData[currentMonth].monthlySalary -= amount;
                }

                saveData();
                updateSalaryDisplay();
                salaryInput.value = '';
            }
        }

        function updateShiftCost() {
            const shiftCostInput = document.getElementById('shift-cost-input');
            const cost = parseInt(shiftCostInput.value);

            if (cost > 0) {
                monthlyData[currentMonth].shiftCost = cost;
                saveData();
                updateSalaryDisplay();
                shiftCostInput.value = '';
            }
        }

        function updateShiftsWorked(change) {
            monthlyData[currentMonth].shiftsWorked += change;
            if (monthlyData[currentMonth].shiftsWorked < 0) {
                monthlyData[currentMonth].shiftsWorked = 0;
            }
            saveData();
            updateSalaryDisplay();
        }

        // Monthly history
        function renderMonthlyHistory() {
            monthlyHistoryEl.innerHTML = '';

            const months = Object.keys(monthlyData).sort().reverse();

            if (months.length === 0) {
                monthlyHistoryEl.innerHTML = '<p>No monthly data available.</p>';
                return;
            }

            months.forEach(month => {
                const data = monthlyData[month];
                const incomeFromShifts = data.shiftCost * data.shiftsWorked;
                const totalIncome = data.monthlySalary + incomeFromShifts;
                const totalExpenses = data.expenses.reduce((sum, expense) => sum + parseFloat(expense.amount), 0);
                const balance = totalIncome - totalExpenses;

                const div = document.createElement('div');
                div.className = 'history-item';

                div.innerHTML = `
                    <div>
                        <strong>${formatMonthKey(month)}</strong>
                        <div>Shifts: ${data.shiftsWorked} | Salary: ₽${data.monthlySalary.toLocaleString()}</div>
                    </div>
                    <div style="text-align: right;">
                        <div>Income: ₽${totalIncome.toLocaleString()}</div>
                        <div>Expenses: ₽${totalExpenses.toLocaleString()}</div>
                        <div><strong>Balance: ₽${balance.toLocaleString()}</strong></div>
                    </div>
                `;

                monthlyHistoryEl.appendChild(div);
            });
        }

        // Download Excel function
        function downloadSalaryExcel() {
            const data = monthlyData[currentMonth];
            const incomeFromShifts = data.shiftCost * data.shiftsWorked;
            const totalIncome = data.monthlySalary + incomeFromShifts;
            const totalExpenses = data.expenses.reduce((sum, expense) => sum + parseFloat(expense.amount), 0);
            const balance = totalIncome - totalExpenses;

            // Prepare data for Excel
            const excelData = [
                ["iManager Monthly tracker Details", "", "", ""],
                ["Month:", formatMonthKey(currentMonth), "", ""],
                ["", "", "", ""],
                ["Salary Overview", "", "", ""],
                ["Monthly Salary", `₽${data.monthlySalary.toLocaleString()}`, "", ""],
                ["Shifts Worked", data.shiftsWorked, "", ""],
                ["Shift Cost", `₽${data.shiftCost.toLocaleString()}`, "", ""],
                ["Income from Shifts", `₽${incomeFromShifts.toLocaleString()}`, "", ""],
                ["Total Income", `₽${totalIncome.toLocaleString()}`, "", ""],
                ["Total Expenses", `₽${totalExpenses.toLocaleString()}`, "", ""],
                ["Current Balance", `₽${balance.toLocaleString()}`, "", ""],
                ["", "", "", ""],
                ["Expense Categories", "Amount", "", ""]
            ];

            // Add expense categories
            const categories = {};
            data.expenses.forEach(expense => {
                if (!categories[expense.category]) {
                    categories[expense.category] = 0;
                }
                categories[expense.category] += expense.amount;
            });

            Object.keys(categories).forEach(category => {
                const categoryName = category.charAt(0).toUpperCase() + category.slice(1);
                excelData.push([categoryName, `₽${categories[category].toLocaleString()}`, "", ""]);
            });

            excelData.push(["", "", "", ""]);
            excelData.push(["Recent Expenses", "Amount", "Category", "Date"]);

            // Add recent expenses
            const recentExpenses = [...data.expenses].reverse().slice(0, 10);
            recentExpenses.forEach(expense => {
                const categoryName = expense.category.charAt(0).toUpperCase() + expense.category.slice(1);
                const date = new Date(expense.date).toLocaleDateString();
                excelData.push([expense.name, `₽${expense.amount.toLocaleString()}`, categoryName, date]);
            });

            // Create worksheet
            const ws = XLSX.utils.aoa_to_sheet(excelData);

            // Create workbook
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Salary Details");

            // Generate Excel file and trigger download
            XLSX.writeFile(wb, `iManager_tracker_${currentMonth}.xlsx`);
        }

        // Save all data to localStorage
        function saveData() {
            localStorage.setItem('iManager_monthlyData', JSON.stringify(monthlyData));
            localStorage.setItem('iManager_notes', JSON.stringify(notes));
            showSaveIndicator();
        }

        // Show save indicator
        function showSaveIndicator() {
            const indicator = document.getElementById('save-indicator');
            indicator.classList.add('show');
            setTimeout(() => {
                indicator.classList.remove('show');
            }, 2000);
        }

        // Expense charts
        let expensePieChart = null;
        let expenseBarChart = null;

        function renderExpenseCharts() {
            const data = monthlyData[currentMonth];
            const categories = {};

            data.expenses.forEach(expense => {
                if (!categories[expense.category]) {
                    categories[expense.category] = 0;
                }
                categories[expense.category] += expense.amount;
            });

            const categoryNames = Object.keys(categories);
            const categoryAmounts = Object.values(categories);

            // Pie Chart
            const pieCtx = document.getElementById('expense-pie-chart');
            if (pieCtx) {
                if (expensePieChart) {
                    expensePieChart.destroy();
                }

                expensePieChart = new Chart(pieCtx, {
                    type: 'doughnut',
                    data: {
                        labels: categoryNames.map(c => c.charAt(0).toUpperCase() + c.slice(1)),
                        datasets: [{
                            data: categoryAmounts,
                            backgroundColor: [
                                '#667eea',
                                '#764ba2',
                                '#f093fb',
                                '#4facfe',
                                '#00f2fe',
                                '#f6d365',
                                '#fda085',
                                '#a8edea'
                            ],
                            borderWidth: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    padding: 15,
                                    font: {
                                        size: 12
                                    }
                                }
                            }
                        }
                    }
                });
            }

            // Bar Chart - Last 6 months
            const barCtx = document.getElementById('expense-bar-chart');
            if (barCtx) {
                const months = Object.keys(monthlyData).sort().slice(-6);
                const monthlyTotals = months.map(month => {
                    return monthlyData[month].expenses.reduce((sum, e) => sum + parseFloat(e.amount), 0);
                });

                if (expenseBarChart) {
                    expenseBarChart.destroy();
                }

                expenseBarChart = new Chart(barCtx, {
                    type: 'bar',
                    data: {
                        labels: months.map(m => formatMonthKey(m).split(' ')[0]),
                        datasets: [{
                            label: 'Total Expenses',
                            data: monthlyTotals,
                            backgroundColor: 'rgba(102, 126, 234, 0.8)',
                            borderColor: '#667eea',
                            borderWidth: 2,
                            borderRadius: 8
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function (value) {
                                        return '₽' + value.toLocaleString();
                                    }
                                }
                            }
                        }
                    }
                });
            }
        }

        // Export data
        function exportData() {
            const data = {
                monthlyData: monthlyData,
                notes: notes,
                exportDate: new Date().toISOString()
            };
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `iManager_backup_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
            showToast('Data exported successfully!');
        }

        // Import data
        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function (e) {
                try {
                    const imported = JSON.parse(e.target.result);
                    monthlyData = imported.monthlyData || monthlyData;
                    notes = imported.notes || notes;
                    saveData();
                    location.reload();
                    showToast('Data imported successfully!');
                } catch (error) {
                    showToast('Error importing data. Invalid file format.', 'error');
                }
            };
            reader.readAsText(file);
            event.target.value = ''; // Reset input
        }

        // Show toast notification
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toast-message');
            toastMessage.textContent = message;

            // Add icon based on type
            let icon = 'fa-check-circle';
            if (type === 'error') icon = 'fa-exclamation-circle';
            else if (type === 'warning') icon = 'fa-exclamation-triangle';
            else if (type === 'info') icon = 'fa-info-circle';

            toastMessage.innerHTML = `<i class="fas ${icon}"></i> ${message}`;
            toast.classList.add('show');
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        // Keyboard shortcuts handler
        function handleKeyboardShortcuts(e) {
            // Don't trigger if typing in input fields
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.tagName === 'SELECT') {
                if (e.key === '?' || (e.ctrlKey && e.key === 'f')) return;
                return;
            }

            // Ctrl/Cmd combinations
            if (e.ctrlKey || e.metaKey) {
                switch (e.key) {
                    case 'n':
                        e.preventDefault();
                        switchTab('tasks');
                        showTaskForm();
                        break;
                    case 'e':
                        e.preventDefault();
                        switchTab('expenses');
                        document.getElementById('expense-name').focus();
                        break;
                    case 'm':
                        e.preventDefault();
                        switchTab('notes');
                        document.getElementById('note-title').focus();
                        break;
                    case 'f':
                        e.preventDefault();
                        document.getElementById('task-search').focus();
                        break;
                }
            }

            // Show shortcuts help
            if (e.key === '?') {
                e.preventDefault();
                document.getElementById('shortcuts-help').classList.toggle('show');
            }

            // Close modals with Escape
            if (e.key === 'Escape') {
                closeTaskDetails();
                document.getElementById('shortcuts-help').classList.remove('show');
            }
        }

        // Render statistics
        function renderStatistics() {
            const data = monthlyData[currentMonth];
            const statsGrid = document.getElementById('stats-grid');

            const totalTasks = data.tasks.length;
            const completedTasks = data.tasks.filter(t => t.completed).length;
            const highPriorityTasks = data.tasks.filter(t => !t.completed && t.priority === 'high').length;
            const totalExpenses = data.expenses.reduce((sum, e) => sum + parseFloat(e.amount), 0);
            const expenseCount = data.expenses.length;
            const avgExpense = expenseCount > 0 ? totalExpenses / expenseCount : 0;

            statsGrid.innerHTML = `
                <div class="stat-card">
                    <div class="stat-label">Total Tasks</div>
                    <div class="stat-value">${totalTasks}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Completed</div>
                    <div class="stat-value">${completedTasks}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">High Priority</div>
                    <div class="stat-value">${highPriorityTasks}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Total Expenses</div>
                    <div class="stat-value">₽${totalExpenses.toLocaleString()}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Expense Count</div>
                    <div class="stat-value">${expenseCount}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Avg Expense</div>
                    <div class="stat-value">₽${avgExpense.toFixed(0)}</div>
                </div>
            `;
        }

        // Update functions to also update statistics
        const originalRenderMonthlyHistory = renderMonthlyHistory;
        renderMonthlyHistory = function () {
            originalRenderMonthlyHistory();
            if (document.getElementById('stats-grid')) renderStatistics();
        };

        const originalRenderTasks = renderTasks;
        renderTasks = function () {
            originalRenderTasks();
            if (document.getElementById('stats-grid')) renderStatistics();
        };

        const originalRenderExpenses = renderExpenses;
        renderExpenses = function () {
            originalRenderExpenses();
            if (document.getElementById('stats-grid')) renderStatistics();
        };
    </script>
</body>

</html>